# Maintainer: Ricky Wu <rickleaf.wu@gmail.com>

_realname=luarocks
pkgbase=mingw-w64-lua-${_realname}
pkgname=("${MINGW_PACKAGE_PREFIX}-lua51-${_realname}")
pkgver=3.3.1
pkgrel=0
pkgdesc="the package manager for Lua modules (mingw-w64)"
arch=('any')
url="https://luarocks.org"
license=("MIT")
install=luarocks-${CARCH}.install
depends=("${MINGW_PACKAGE_PREFIX}-lua51")
makedepends=("${MINGW_PACKAGE_PREFIX}-gcc"
             "unzip")
options=('staticlibs' 'strip')
source=("https://luarocks.org/releases/${_realname}-${pkgver}.tar.gz")
sha256sums=('eb20cd9814df05535d9aae98da532217c590fc07d48d90ca237e2a7cdcf284fe')

prepare() {
  cd "${srcdir}/${_realname}-${pkgver}"
  # patch -p1 -i ${srcdir}/mingw32-msys2.patch
}

build() {
  #mkdir -p "build-${MINGW_CHOST}"
  cd "${srcdir}/${_realname}-${pkgver}"

  ../${_realname}-${pkgver}/configure \
    --prefix=${MINGW_PREFIX} \
    --with-lua-bin=${MINGW_PREFIX}/bin \
    --with-lua-interpreter=lua5.1.exe

  sed -i -e 's,LUA_PATH=",LUA_PATH="$$(cygpath -w $(CURDIR)/src/)?.lua;,g' GNUmakefile
  sed -i -e "s,\\./luarocks init,./luarocks config lua_dir \"$(cygpath -w ${MINGW_PREFIX} | sed -e 's/\\/\\\\/g')\" \&\& ./luarocks init," GNUmakefile

  make VERBOSE=1
}

package() {
  cd "${srcdir}/${_realname}-${pkgver}"
  make DESTDIR="${pkgdir}" install
}
